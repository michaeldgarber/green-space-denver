---
title: "Supplemental tables & figures for NATURGREEN paper"
author: "Michael D Garber"
date: '2022-05-19'
#always_allow_html: true
#note word doesn't seem to render unless I render the whole site ()rmarkdown::render_site(encoding = 'UTF-8')
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_depth: 4
    include: 
      after_body: footer.html
  bookdown::word_document2:
    toc: true 
---

Filename: 4_appendix_tables_figs

The purpose of this is to output tables and  figures for the appendix.
Eventually, this could be rendered as a Word Doc or PDF for an appendix corresponding to a submitted manuscript. 
For now, it's simpler to keep as an html.

# Study area demographics

## Table of total population, population density, age, race, and poverty of study area

```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
library(here)
library(tidyverse)
library(mapview)
library(sf)
#all of this info is created here:
#scripts/0_import_manage_denver_acs.R
setwd(here("data-processed"))
load("lookup_tract_nbhd_northeast_exclude.RData")
load("den_tract_acs5_wrangle_geo.RData")
#names(den_tract_acs5_wrangle_geo)
#use tract-level data for the overall table
den_tract_acs5_wrangle_geo %>% 
  filter(county_fips=="031") %>% 
  left_join(lookup_tract_nbhd_northeast_exclude, by = "tract_fips") %>% 
  filter(nbhd_northeast_exclude==0) %>% 
  st_set_geometry(NULL) %>% 
  group_by(county_fips) %>% 
  summarise(
    area_mi2 = sum(area_mi2_tract, na.rm=TRUE),
    pop_tot = sum(pop_tot, na.rm=TRUE),
    
    age_med = median(age_med , na.rm=TRUE),
    hh_inc_med = median(hh_inc_med, na.rm=TRUE),
    
    race_tot = sum(race_tot, na.rm=TRUE),
    race_w = sum(race_w, na.rm=TRUE),
    race_h = sum(race_h, na.rm=TRUE),
    race_b = sum(race_b, na.rm=TRUE),
    
    pov_last_12 = sum(pov_last_12, na.rm=TRUE),
    pov_last_12_tot = sum(pov_last_12_tot, na.rm=TRUE),

  ) %>% 
  ungroup() %>% 
  mutate(
    pop_dens_mi2 = pop_tot/area_mi2,
    race_w_prop = race_w/race_tot,           #prop for proportion
    race_b_prop = race_b/race_tot,
    race_h_prop = race_h/race_tot, 
    race_nw_prop = 1-race_w_prop, #nw for nonwhite (i.e, 1-white)
    race_o_prop = 1-(race_b_prop + race_w_prop +race_h_prop),
    
    pov_last_12_prop = pov_last_12/pov_last_12_tot  #percent poverty
  ) %>% 
  dplyr::select(
    area_mi2, pop_tot, pop_dens_mi2, race_w_prop, race_b_prop, race_h_prop, race_o_prop,
    age_med,
    pov_last_12_prop,
    hh_inc_med
  ) %>% 
  pivot_longer(
    cols = everything(),
    names_to = "Measure"
    ) %>% 
  knitr::kable(digits = 2)

```

## Map population density by block group
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
#scripts/0_import_manage_denver_acs.R
setwd(here("data-processed"))
load("lookup_tract_nbhd_northeast_exclude.RData")
load("den_bg_acs5_wrangle_geo.RData")
den_bg_acs5_wrangle_geo %>% 
  filter(county_fips=="031") %>% 
  left_join(lookup_tract_nbhd_northeast_exclude, by = "tract_fips") %>% 
  filter(nbhd_northeast_exclude==0) %>% 
  dplyr::select(ends_with( "fips"), contains("pop_dens")) %>% 
  mapview(
    layer.name = "Population density per square mile",
    zcol = "pop_dens_mi2_all")
```

## Map median age by census tract
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
setwd(here("data-processed"))
load("lookup_tract_nbhd_northeast_exclude.RData")
load("den_bg_acs5_wrangle_geo.RData")
load("den_tract_acs5_wrangle_geo.RData")
den_tract_acs5_wrangle_geo %>% 
  filter(county_fips=="031") %>% 
  left_join(lookup_tract_nbhd_northeast_exclude, by = "tract_fips") %>% 
  filter(nbhd_northeast_exclude==0) %>% 
  dplyr::select(ends_with( "fips"), contains("age")) %>% 
  mapview(
    layer.name = "Median age",
    zcol = "age_med")
```

## Map race (proportion non-white) by census tract
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
setwd(here("data-processed"))
load("lookup_tract_nbhd_northeast_exclude.RData")
load("den_tract_acs5_wrangle_geo.RData")
den_tract_acs5_wrangle_geo %>% 
  filter(county_fips=="031") %>% 
  left_join(lookup_tract_nbhd_northeast_exclude, by = "tract_fips") %>% 
  filter(nbhd_northeast_exclude==0) %>% 
  dplyr::select(ends_with( "fips"), contains("race")) %>% 
  mapview(
    layer.name = "Proportion non-white race",
    zcol = "race_nw_prop")
```

## Map percent in poverty in last 12 months by census tract
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
setwd(here("data-processed"))
load("lookup_tract_nbhd_northeast_exclude.RData")
load("den_tract_acs5_wrangle_geo.RData")
den_tract_acs5_wrangle_geo %>% 
  filter(county_fips=="031") %>% 
  left_join(lookup_tract_nbhd_northeast_exclude, by = "tract_fips") %>% 
  filter(nbhd_northeast_exclude==0) %>% 
  dplyr::select(ends_with( "fips"), contains("pov")) %>% 
  mapview(
    layer.name = "Proportion in poverty, last year",
    zcol = "pov_last_12_prop")
```

## Map median household income by census tract
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
setwd(here("data-processed"))
load("lookup_tract_nbhd_northeast_exclude.RData")
load("den_tract_acs5_wrangle_geo.RData")
den_tract_acs5_wrangle_geo %>% 
  filter(county_fips=="031") %>% 
  left_join(lookup_tract_nbhd_northeast_exclude, by = "tract_fips") %>% 
  filter(nbhd_northeast_exclude==0) %>% 
  dplyr::select(ends_with( "fips"), contains("hh_inc")) %>% 
  mapview(
    layer.name = "Median household income",
    zcol = "hh_inc_med")
```

# Native-plants polygons

## Map of native-plants polygons
```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
#I need a version that is just points because the polygons are hard to see on the map
library(here)
library(tidyverse)
library(sf)
library(terra)
library(raster) 
library(mapview)
library(knitr) #to make sure kable works
library(viridis)
library(scales)
library(lubridate) #for ggplot
setwd(here("data-processed"))
load("places_native_geo.RData")
load("places_native_nogeo.RData")
load("native_places_ndvi_day_nogeo.RData")
sf::sf_use_s2(FALSE) 
places_native_geo_points = places_native_geo %>% 
  st_make_valid() %>% 
  st_centroid()

mv_places_native_polygons = places_native_geo %>% 
  mapview(zcol = "place_type",
          layer.name = "Place category (as polygons)")

mv_places_native_points = places_native_geo_points %>% 
  mapview(zcol = "place_type",
          layer.name = "Place category (as points)")

library(leaflet)
library(leaflet.extras)
mv_places_polygons_points =mv_places_native_points+
  mv_places_native_polygons

mv_places_polygons_points@map %>% 
  addFullscreenControl()

```

\newpage

## NDVI of native-plants polygons
```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
library(here)
library(tidyverse)
library(rmarkdown)
library(sf)
setwd(here("data-processed"))
load("places_native_geo.RData")
load("places_native_nogeo.RData")
load("native_places_ndvi_day_nogeo.RData")
native_places_ndvi_day_nogeo %>% 
  filter(date_is_valid_all==1) %>% 
  group_by(place_type, place_name_fac) %>% 
  summarise(
    ndvi_mean = mean(ndvi_mean_wt, na.rm=TRUE), # mean of means
    ndvi_25th = quantile(ndvi_med, probs =c(0.25), na.rm=TRUE), #percentile of medians
    ndvi_med = median(ndvi_med, na.rm=TRUE), #percentile of medians
    ndvi_75th = quantile(ndvi_med, probs =c(0.75), na.rm=TRUE) ) %>% #percentile of medians
  ungroup() %>% 
  as_tibble() %>% 
  knitr::kable(
    booktabs = TRUE,
    caption = "NDVI of selected places of varying levels of plant nativity on selected cloud-free summer (May, June, July, August) days over five years (2016-2021)",
        col.names = c("Place type", "Place name", "NDVI, mean", "NDVI, 25th-ile", "NDVI, 50th-ile", "NDVI, 75th-ile"),
    digits=2)
```

