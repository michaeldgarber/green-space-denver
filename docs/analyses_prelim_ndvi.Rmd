---
title: "Preliminary NDVI analyses, Denver area"
author: "Michael D Garber"
date: "February 2, 2022"
---

This document presents some preliminary analyses characterizing the NDVI of certain places and census tracts throughout the Denver area.

First, load packages used in this Rmarkdown doc.
```{r loadpackages, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
library(here)
library(tidyverse)
library(sf)
library(terra)
library(raster) 
library(mapview)
library(knitr) #to make sure kable works
library(viridis)
library(scales)
library(lubridate) #for ggplot
```

# NDVI for the Denver area, 2016-2021
We obtained the normalized difference vegetation index (NDVI) from the Landsat-8 satellite at a resolution of 30 meters squared at a roughly 15-day interval between 2016 and 2021 for the following area around Denver:

## Study area
```{r denverbbox, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
setwd(here("data-processed"))
load("den_metro_bbox_custom.RData")
#around Denver and Jefferson Counties but only as far south as Castle Rock, i.e, not all of Jeff Co to limit data gathered
mv_den_metro_bbox_custom = den_metro_bbox_custom %>% mapview(layer.name = "Study area")
mv_den_metro_bbox_custom
```

We gathered this data using the [rgee package](https://cran.r-project.org/web/packages/rgee/index.html), an R package that facilitates connection to the Google Earth Engine via Python. Please see these two scripts for specific details on the process for gathering and processing the NDVI data in this area:

https://github.com/michaeldgarber/green-space-denver/blob/main/scripts/1a_get_landsat_ndvi_denver.R

https://github.com/michaeldgarber/green-space-denver/blob/main/scripts/1b_wrangle_check_landsat_ndvi_denver.R

## NDVI for one day
Here is the NDVI over the study area on a cloud-free day, July 4, 2021:
```{r terragoodmo, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
setwd(here("data-processed"))
pal_viridis_trunc=viridis::viridis_pal(end=.9) #trunc for truncated
ndvi_den_metro_terr_5_yr = terra::rast("ndvi_den_metro_terr_5_yr.tif")
mv_good_date =ndvi_den_metro_terr_5_yr$`20210704_NDVI` %>% 
  raster::raster() %>%  
  mapview(
    col.regions = pal_viridis_trunc,
    layer.name = "NDVI, July 4, 2021")
mv_good_date
```


# Characterize NDVI of places of interest
## Determine valid dates by testing a few places
First, pick a few places where we would expect NDVI to be high in the summer on a cloud-free day. If it's not high, then we can assume the image is bad (i.e., clouds in the way). These test places were determined by examining the cloud-free day (July 4, 2021) above. We chose three areas: an area east of Evergreen, Colorado; a plot in City Park; and a plot in the Indian Tree Golf Club:

(These areas are defined here: https://github.com/michaeldgarber/green-space-denver/blob/main/scripts/1b_wrangle_check_landsat_ndvi_denver.R)

```{r loadtestareas, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
setwd(here("data-processed"))
load("bbox_evergreen_east.RData")
load("bbox_indian_tree_golf.RData")
load("bbox_city_park.RData")
mv_evergreen_east = bbox_evergreen_east %>%
  mapview(col.regions = "red", alpha.regions = .2, layer.name = "Evergreen East")
mv_indian_tree_golf = bbox_indian_tree_golf %>%
  mapview(col.regions = "red", alpha.regions = .2, layer.name = "Indian Tree Golf")
mv_city_park =bbox_city_park %>%
  mapview(col.regions = "red", alpha.regions = .2, layer.name = "City Park plot")
mv_den_metro_bbox_custom = den_metro_bbox_custom %>% mapview(layer.name = "Study area")
mv_den_metro_bbox_custom+ mv_evergreen_east + mv_indian_tree_golf + mv_city_park
```

## What is NDVI over time for these places?
Let's look at the temporal NDVI trend for these three places, without excluding any dates. This is the mean NDVI on that day. That is, each place includes several pixels of size 30 meters squared. This is the average of the NDVI for those pixels for that place on that day.
```{r testplacesggplot, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE, fig.width=10}
setwd(here("data-processed"))
load("ndvi_test_places_day_wrangle.RData")
ndvi_test_places_day_wrangle %>% 
  ggplot(
    aes(
      x=date, 
      y=ndvi_mean  
    ))+
  geom_line(aes(colour = test_place_name))+
  geom_point(aes(colour = test_place_name))+
  scale_x_date(labels=date_format("%Y-%m-%d"), date_breaks = "3 months")+
  theme(axis.text.x = element_text(angle = 45, hjust=1))
```

Hmm, if we look closely, we can see that there are some very low NDVI values for some of these places even in the summer, which is not plausible. Those low values must indicate obstruction by clouds. For example, look at a day when NDVI was measured as very low in City Park despite it being mid-May when we would expect it to be higher. So I'm going to exclude dates like these. The specific thresholds are noted in this script (https://github.com/michaeldgarber/green-space-denver/blob/main/scripts/1b_wrangle_check_landsat_ndvi_denver.R) and warrant further discussion.
```{r mapviewbaddate, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
setwd(here("data-processed"))
pal_viridis_trunc=viridis::viridis_pal(end=.9) #trunc for truncated
ndvi_den_metro_terr_5_yr = terra::rast("ndvi_den_metro_terr_5_yr.tif")
mv_bad_date =ndvi_den_metro_terr_5_yr$`20180517_NDVI` %>% #Use 2018-05-17
  raster::raster() %>%  
  mapview(
    col.regions = pal_viridis_trunc,
    layer.name = "NDVI, May 17, 2018")
mv_bad_date
```



## Load places of interest

Load the places-of-interest dataset, which is created here:

https://github.com/michaeldgarber/green-space-denver/blob/main/scripts/0_read_denver_native_zones.R

```{r loaddata, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
setwd(here("data-processed"))
load("places_native_geo.RData")
load("places_native_nogeo.RData")
```

Print information about the places of interest, including approximate percent nativity where available.
```{r printtibble, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE, results = 'asis'}
places_native_nogeo %>% 
  dplyr::select(place_name, native_percent, place_type, place_id) %>% 
  kable()
```

Map these places by type (nativity spectrum or high-plant diversity).
```{r mapview, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE}
places_native_geo %>% 
  mapview(zcol = "place_type",
          layer.name = "Place category")
```
