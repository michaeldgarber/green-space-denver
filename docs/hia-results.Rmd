---
title: "Preliminary health-impact assessment results"
author: "Michael D Garber"
date: "Revised April 4 2022"
output: 
  html_document:
    toc: true  
    toc_float: true
---
```{r loadpackages, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
library(here)
library(tidyverse)
library(sf)
library(terra)
library(raster) 
library(mapview)
library(knitr) #to make sure kable works
library(viridis)
library(scales)
library(lubridate) #for ggplot
library(leaflet)
library(leaflet.extras)
```

# Introduction
This document describes and presents initial results for the health-impact assessment related to adding more native plants to City of Denver. We aim to estimate the number of deaths that would be prevented by adding more green space, specifically native plants, to the City of Denver. We estimate the number of deaths prevented corresponding to three broad greening scenarios, which were informed by conversations with local stakeholders. The scenarios are:

* Add native plants to all census block groups such that
    * 100% of the block group's area is as green as native plants
    * 20% of the block group's area is as green as native plants
  
* Create native buffers around riparian areas (rivers, streams, lakes, and ponds) of the following sizes:
    * 200 feet (ideal for ecosystem health but possibly not realistic)
    * 100 feet (compromise)
    * 50 feet (most realistic; less good for ecosystem health)
    
* Replace a portion of parking-lot surface with native plants:
    * 100% of the existing parking area
    * 50% of the existing parking area
    * 20% of the existing parking area
  

For all scenarios, we measured green-space exposure by the normalized difference vegetation index (NDVI) measured by the Landsat-8 satellite at a spatial resolution of 30 meters squared.  To determine the target NDVI value, we measured the NDVI of a 100% native zone in the Denver Botanic Gardens on several cloud-free spring and summer days. The NDVI value was about 0.5 in this area, so we assumed that, by adding more native plants to places in Denver, the NDVI of those areas would change to 0.5.

# Scenario 1: add native plants to all census block groups

We first measured the mean NDVI of each census block group on July 4, 2021. The weighted block-group-level mean is presented here, weighted by the proportion each 30 square-meter pixel covers by the census block group. For example, if half of a pixel overlaps the block group, it receives a weight of 0.5 in the weighted average. We also removed bodies of water before measuring NDVI.

```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
setwd(here("data-processed"))
load("den_co_bg_ndvi.RData")
load("mv_ndvi_pixel_bg.RData")
load("mv_ndvi_den_co_20210704.RData")
load("mv_den_co_bg_ndvi.RData")
#mv_den_co_bg_ndvi
pal_terrain = terrain.colors(100) %>% rev()#reverse the order of the palette
mv_den_co_bg_ndvi  = den_co_bg_ndvi %>% 
  dplyr::select(bg_fips, ndvi_mean_wt) %>% 
  mapview(
    layer.name = "NDVI, block group",
    zcol = "ndvi_mean_wt",
    col.regions = pal_terrain, 
    at = seq(-0.1, 1, 0.1)
  )
mv_den_co_bg_ndvi@map %>% 
  addFullscreenControl()
```

We excluded census block whose baseline NDVI was above the native-plant threshold:
```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
library(RColorBrewer)
setwd(here("data-processed"))
ndvi_below_thresh_pal = RColorBrewer::brewer.pal(3, "RdYlGn")[c(1,3)]  %>% rev()
mv_bg_below_native_threshold =den_co_bg_ndvi %>% 
  mutate(
  ndvi_below_native_threshold_char = case_when(
    ndvi_below_native_threshold == 1 ~ "Yes",
    ndvi_below_native_threshold == 0 ~ "No"
  )) %>% 
  dplyr::select(bg_fips, ndvi_below_native_threshold_char) %>% 
  mapview(
    layer.name = "NDVI below native threhsold",
    zcol = "ndvi_below_native_threshold_char",
    col.regions = ndvi_below_thresh_pal
  )

mv_bg_below_native_threshold@map %>% 
  addFullscreenControl()
```
# Scenario 2: add native-plants buffers to riparian areas
We measured NDVI in a 200-foot buffer, a 100-foot buffer, and a 50-foot buffer around all bodies of water in Denver. We downloaded bodies of water from OpenStreetMap (code [here](https://github.com/michaeldgarber/green-space-denver/blob/main/scripts/0_load_denver_osm_parks_water.R). We defined residential exposure to these riparian areas as those individuals living within a 500-meter buffer, following the green-space literature that has defined green-space exposure based on residential proximity. We estimated the number of people in this buffer by multiplying the population density of the census block group by the intersecting area. 

The below map depicts mean NDVI in the portions of census block groups that intersect a 200-foot buffer as well as those pieces that intersect the part of the 500 m buffer that would not be intervened upon, i.e., the part between the 200-foot buffer and the edge of the 500 m buffer.

```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
library(here)
setwd(here("data-processed"))
load("den_bg_int_wtr_500m_200ft_comp_ndvi.RData")
load("den_bg_int_wtr_200ft_ndvi.RData")
load("den_co_osm_wtr.RData")
load("study_area_2876.RData")
pal_terrain_col = rev(terrain.colors(100)) 
mv_den_bg_int_wtr_500m_200ft_comp_ndvi= den_bg_int_wtr_500m_200ft_comp_ndvi %>% 
  mapview(
    col.regions = pal_terrain_col,
    at = seq(-.1, 1, 0.1), #0 to 1 by .1; define the breaks so consistent between layers
    layer.name = "NDVI, 200 ft - 500 m",
    zcol = "ndvi_mean_wt_500m_200ft_comp")

mv_den_bg_int_wtr_200ft_ndvi= den_bg_int_wtr_200ft_ndvi %>% 
  mapview(
    col.regions = pal_terrain_col,
    at = seq(-.1, 1, 0.1), #0 to 1 by .1; define the breaks so consistent between layers
    layer.name = "NDVI, 200 ft",
    zcol = "ndvi_mean_wt_200ft")

mv_den_co_osm_wtr = den_co_osm_wtr %>% 
  st_intersection(study_area_2876) %>% 
  mapview(
    layer.name = "Water type",
    col.regions = rainbow(n_distinct(den_co_osm_wtr$water_type)),
    zcol = "water_type")

#### Visualize all at once--------
mv_rip_all3 = mv_den_bg_int_wtr_200ft_ndvi+ mv_den_bg_int_wtr_500m_200ft_comp_ndvi +mv_den_co_osm_wtr
mv_rip_all3@map %>% 
  addFullscreenControl()
```

# Scenario 4: add native plants to parking lots
We obtained spatial data on [parking lots](https://www.denvergov.org/opendata/dataset/parking-lots-2016) from the City of Denver Open Data Catalog. About 9% of the city is covered with parking lots:
```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
setwd(here("data-processed"))
load("den_prkng_sum_marg.RData")
den_prkng_sum_marg %>% 
  st_set_geometry(NULL) %>% 
  mutate(
    den_area_mi2_total = 155,
    percent_area_covered_by_parking = area_mi2/den_area_mi2_total
         ) %>% 
  dplyr::select(-area_ft2) %>% 
  knitr::kable()
```

We similarly measured the NDVI on the parking lots as well as the NDVI in the census block groups that are within a 500-m buffer radius of any parking lots (which is most).

We present a small subset, as the file size with the full map rendered exceeds GitHub's file-upload limits:

```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
#080310017021
# 080310017022
#080310020001
#080310019021
#080310017015
#080310017013
#080310017011
setwd(here("data-processed"))
load("den_bg_int_prkng_500m_comp_ndvi.RData")
load("den_bg_int_prkng_only_ndvi.RData")
load("study_area_2876.RData")
pal_terrain_col = rev(terrain.colors(100)) 
library(leaflet.extras)
#### Buffer excluding the parking---------
mv_den_bg_int_prkng_500m_comp_ndvi= den_bg_int_prkng_500m_comp_ndvi %>% 
  mutate(
    bg_for_github = case_when(
      bg_fips %in% c("080310017021", "080310017022", "080310020001", "080310019021", "080310017015", "080310017013", "080310017011", "080310017014") ~1,
      TRUE ~ 0
    )) %>% 
      filter(bg_for_github==1) %>% 
  mapview(
    col.regions = pal_terrain_col,
    layer.name = "NDVI, 500 m buffer, parking",
    zcol = "ndvi_mean_wt_500m_prkng_comp")

#### The parking only----------
mv_den_bg_int_prkng_only_ndvi= den_bg_int_prkng_only_ndvi %>% 
    mutate(
    bg_for_github = case_when(
      bg_fips %in% c("080310017021", "080310017022", "080310020001", "080310019021", "080310017015", "080310017013", "080310017011", "080310017014") ~1,
      TRUE ~ 0
    )) %>% 
      filter(bg_for_github==1) %>% 
  mapview(
    col.regions = pal_terrain_col,
    layer.name = "NDVI, parking only",
    zcol = "ndvi_mean_wt_prkng_only")


#### Visualize all at once--------------
mv_prkng_both = mv_den_bg_int_prkng_500m_comp_ndvi+ mv_den_bg_int_prkng_only_ndvi 

mv_prkng_both@map %>% 
  addFullscreenControl()

```


# Results
We estimated the number of deaths averted under each scenario by following a recent meta-analyses that estimated that for every 0.1 unit increase in exposure to NDVI, the relative risk of death decreases about 4% (pooled risk ratio of 0.96, 95% confidence interval (CI): 0.94, 0.97)1. We defined NDVI exposure as that within a 500-meter buffer of the individualâ€™s place of residence. We used this risk ratio to estimate the population attributable fraction corresponding to the proposed change in NDVI from the baseline level to the native-plants level for each census block group (first scenario) or the part of the census block group intersecting the proposed intervention area (riparian and parking scenarios). We then estimated the number of deaths prevented considering estimates of population and all-cause mortality rates. We used 5-year American Community Survey Data (2015-2019) to estimate the population in 5-year age groups in each census block group and age-stratified estimates of mortality rates for the state of Colorado from the Global Burden of Disease project. If an intervention area did not cover an entire census block group, we multiplied the population density of the block group in that age group by the area of the block group covered by the intervention area to estimate the total population in the area affected by the intervention. We restricted analyses to adults aged 30 and above following the age range of many of the cohort studies reviewed. We also restricted analyses to those census block groups or census-block-group pieces below the native-plants NDVI threshold.

```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
setwd(here("data-processed"))
load("all_sc_marg_lf.RData")
all_sc_marg_lf %>%  
  dplyr::select(-starts_with("ndvi_below")) %>% 
  dplyr::select(scenario, scenario_sub, pop_affected, attrib_deaths) %>% 
  knitr::kable()
```

# Next steps (as of April 4, 2022)
* Add equity component

* Add economic-impact attributable to health

* Incorporate uncertainty throughout (via bootstrapping)