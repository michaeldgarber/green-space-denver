---
title: "Population density and NDVI: possible measures considering both"
author: "Michael D Garber"
date: '2022-05-24'
#always_allow_html: true
#note word doesn't seem to render unless I render the whole site ()rmarkdown::render_site(encoding = 'UTF-8')
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_depth: 4
    include: 
      after_body: footer.html
  bookdown::word_document2:
    toc: true 
---

This page presents some ideas for expressing NDVI in terms of population density for the City of Denver, Colorado.

```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(sf)
library(mapview)
library(here)
library(terra)
library(raster)
library(leaflet)
library(leaflet.extras)
setwd(here("data-processed"))
load("den_co_bg_pop_per_ndvi.RData") #made in scripts/4_pop_dens_per_ndvi.R
```

# Population density
A map of population density by block group per 2016-2020 American Community Survey 5-year Estimates
```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
mv_den_co_bg_pop_per_ndvi =den_co_bg_pop_per_ndvi %>% 
  mapview(zcol = "pop_dens_mi2_all",
    layer.name = "Popuplation density per square mile")

mv_den_co_bg_pop_per_ndvi@map %>% 
  addFullscreenControl()
```
Population density tertiles
```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
pal_terrain_3_cat = rev(terrain.colors(4)[1:3])
den_co_bg_pop_per_ndvi %>% 
  mapview(
    layer.name = "Population density tertile",
    zcol = "pop_dens_mi2_tertile")
```

# NDVI
A map of NDVI of each block group. Note NDVI is measured using Landsat-8 at a spatial resolution of 30 meters squared on July 4, 2021, a cloud-free day. The weighted average NDVI of each block group excludes bodies of water.
```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
pal_terrain = terrain.colors(100) %>% rev()#reverse the order of the palette
mv_den_co_bg_ndvi  = den_co_bg_pop_per_ndvi %>% 
  dplyr::select(bg_fips, ndvi_mean_wt) %>% 
  mapview(
    layer.name = "NDVI, block group",
    zcol = "ndvi_mean_wt",
    col.regions = pal_terrain, 
    at = seq(-0.1, 1, 0.1)
  )
mv_den_co_bg_ndvi@map %>% 
  addFullscreenControl()
```

NDVI tertiles, overall
```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
den_co_bg_pop_per_ndvi %>% 
  mapview(
    layer.name = "NDVI tertile",
    col.regions = pal_terrain_3_cat, 
    zcol = "ndvi_tertile_overall")
```

# Explore relationship between population density and NDVI
## Scatterplot
```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
den_co_bg_pop_per_ndvi %>% 
  ggplot(aes(x=pop_dens_mi2_all, y=ndvi_mean_wt )) + 
  geom_point(aes(colour=pop_dens_mi2_tertile ), size = 1) +
  ylab("NDVI") +
  xlab("Pop. density") +
  theme_bw(base_size = 14) +
  scale_color_hue(
    name = "Pop. density tertile"
  )
```

## Map of NDVI tertiles within tertiles of population density
```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
pop_dens_mi2_tertile_1 = den_co_bg_pop_per_ndvi %>% 
  st_set_geometry(NULL) %>% 
  group_by(pop_dens_mi2_tertile) %>% 
  summarise(n=n()) %>% 
  dplyr::select(pop_dens_mi2_tertile) %>% 
  ungroup() %>% 
  dplyr::slice(1) %>% 
  pull()

pop_dens_mi2_tertile_2 = den_co_bg_pop_per_ndvi %>% 
  st_set_geometry(NULL) %>% 
  group_by(pop_dens_mi2_tertile) %>% 
  summarise(n=n()) %>% 
  dplyr::select(pop_dens_mi2_tertile) %>% 
  ungroup() %>% 
  dplyr::slice(2) %>% 
  pull()

pop_dens_mi2_tertile_3 = den_co_bg_pop_per_ndvi %>% 
  st_set_geometry(NULL) %>% 
  group_by(pop_dens_mi2_tertile) %>% 
  summarise(n=n()) %>% 
  dplyr::select(pop_dens_mi2_tertile) %>% 
  ungroup() %>% 
  dplyr::slice(3) %>% 
  pull()

#See mapview issue regarding a bug in getting the labels to print.
#That's why I'm simply calling the categorie 1, 2, 3, which is less informative
#than including the actual range of values, but this will work for now.
pal_terrain_3_cat = rev(terrain.colors(4)[1:3])
mv_ndvi_tertile_pop_dens_1 = den_co_bg_pop_per_ndvi %>% 
  filter(pop_dens_mi2_tertile== pop_dens_mi2_tertile_1) %>% 
  mapview(
    layer.name = "NDVI tertile within pop. dens. tertile 1 (lowest)",
    col.regions = pal_terrain_3_cat, 
    zcol = "ndvi_tertile_within_pop_dens_tertile_label")

mv_ndvi_tertile_pop_dens_2 =den_co_bg_pop_per_ndvi %>% 
  filter(pop_dens_mi2_tertile== pop_dens_mi2_tertile_2) %>% 
  mapview(
    layer.name = "NDVI tertile within pop. dens tertile 2 (middle)",
    col.regions = pal_terrain_3_cat, 
    zcol = "ndvi_tertile_within_pop_dens_tertile_label")

mv_ndvi_tertile_pop_dens_3 =den_co_bg_pop_per_ndvi %>% 
  filter(pop_dens_mi2_tertile== pop_dens_mi2_tertile_3) %>% 
  mapview(
    layer.name = "NDVI tertile within pop. dens. tertile 3 (highest)",
    col.regions = pal_terrain_3_cat, 
    zcol = "ndvi_tertile_within_pop_dens_tertile_label")

mv_ndvi_tertile_overall =den_co_bg_pop_per_ndvi %>% 
  mapview(
    layer.name = "NDVI tertile, overall",
    col.regions = pal_terrain_3_cat, 
    zcol = "ndvi_tertile_overall")

mv_ndvi_pop_dens_tertile_combined = mv_ndvi_tertile_pop_dens_1 + 
  mv_ndvi_tertile_pop_dens_2+
  mv_ndvi_tertile_pop_dens_3 + 
  mv_ndvi_tertile_overall

mv_ndvi_pop_dens_tertile_combined@map %>% 
  leaflet.extras::addFullscreenControl()
```

# Possible composite measures considering both population density and NDVI
1. Population density per NDVI (population density per square mile / NDVI)
2. A ranking of population density per NDVI
3. Quantiles within quantiles as above.

The first is somewhat difficult to visualize on a map because the distribution has a right skew with some very high values and most much lower.
```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
summary(den_co_bg_pop_per_ndvi$pop_dens_per_ndvi)
den_co_bg_pop_per_ndvi %>% 
  ggplot(aes(pop_dens_per_ndvi))+
  geom_histogram()+
  theme_bw(base_size = 14) +
  xlab("Pop. density per NDVI")
```

The second is easier to visualize because the distribution is uniform by definition (a simple rank).
```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
summary(den_co_bg_pop_per_ndvi$pop_dens_per_ndvi_rank)
den_co_bg_pop_per_ndvi %>% 
  ggplot(aes(pop_dens_per_ndvi_rank))+
  geom_histogram()+
  theme_bw(base_size = 14) +
  xlab("Block group ranking of pop. density per NDVI")
```

Map population density per NDVI and the ranking of population density per NDVI on the same map.
```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
library(viridis)
library(scales)
mv_pop_dens_per_ndvi=den_co_bg_pop_per_ndvi %>% 
  mapview(
    col.regions = viridis_pal(option = "C"),
    layer.name = "Pop. density per NDVI",
    zcol = "pop_dens_per_ndvi")

mv_rank=den_co_bg_pop_per_ndvi %>% 
  mapview(
    col.regions = viridis_pal(option = "C"),
    layer.name = "Rank of pop. density per NDVI",
    zcol = "pop_dens_per_ndvi_rank")

mv_both = mv_pop_dens_per_ndvi +
  mv_rank

mv_both@map %>% 
  leaflet.extras::addFullscreenControl()
```
