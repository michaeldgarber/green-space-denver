---
title: "Population density per NDVI: possible metrics"
author: "Michael D Garber"
date: '2022-05-24'
#always_allow_html: true
#note word doesn't seem to render unless I render the whole site ()rmarkdown::render_site(encoding = 'UTF-8')
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_depth: 4
    include: 
      after_body: footer.html
  bookdown::word_document2:
    toc: true 
---

This page presents some ideas for expressing NDVI in terms of population density for the City of Denver, Colorado.

```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
#Note to self: for initial coding in an R script, see ~scripts/4_pop_dens_per_ndvi.R

library(tidyverse)
library(sf)
library(mapview)
library(here)
library(terra)
library(raster)
library(leaflet)
library(leaflet.extras)
setwd(here("data-processed"))
load("lookup_den_co_bg_no_wtr_geo.RData") #created ~scripts/3_HIA_for_each_scenario.R
load("den_co_bg_ndvi_alt_all_nogeo.RData") #from  scripts/3_HIA_for_each_scenario.R
load("den_bg_acs5_wrangle_geo.RData") #from ~scripts/0_import_manage_denver_acs.R
load("lookup_den_co_bg_ndvi_mean_wt.RData")
load("lookup_tract_nbhd_northeast_exclude.RData")

den_co_bg_pop_per_ndvi =  den_bg_acs5_wrangle_geo %>% 
  filter(county_fips == "031") %>% 
  left_join(lookup_den_co_bg_ndvi_mean_wt, by = "bg_fips") %>% 
  left_join(lookup_tract_nbhd_northeast_exclude, by = "tract_fips") %>% 
  filter(nbhd_northeast_exclude==0) %>% #exclude the northeast airport-adjacent tracts. nobody or very few people
  mutate(
    pop_dens_per_ndvi = case_when(
      is.na(ndvi_mean_wt)==TRUE ~ NA_real_,
      is.na(pop_dens_mi2_all)==TRUE ~ NA_real_,
      pop_dens_mi2_all <5 ~ NA_real_,
      TRUE ~ pop_dens_mi2_all/ndvi_mean_wt
  ),
  #try a ranking for both pop. density and NDVI
  #https://dplyr.tidyverse.org/reference/ranking.html
  pop_dens_mi2_all_rank = dense_rank(pop_dens_mi2_all),
  ndvi_mean_wt_rank = dense_rank(ndvi_mean_wt),
  
  #and then do a ratio of those two ranks
  pop_dens_per_ndvi_ratio_of_ranks = pop_dens_mi2_all_rank/ndvi_mean_wt_rank,
  pop_dens_per_ndvi_rank = dense_rank(pop_dens_per_ndvi)   #rank the ratio
  ) %>% 
  dplyr::select(
    ends_with("fips"), pop_tot, contains("pop_dens"), contains("ndvi"), contains("nbhd_northeast"))
```

# Population density
A map of population density by block group per 2016-2020 American Community Survey 5-year Estimates
```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
mv_den_co_bg_pop_per_ndvi =den_co_bg_pop_per_ndvi %>% 
  mapview(zcol = "pop_dens_mi2_all",
    layer.name = "Popuplation density per square mile")

mv_den_co_bg_pop_per_ndvi@map %>% 
  addFullscreenControl()
```

# NDVI
A map of NDVI of each block group. Note NDVI is measured using Landsat-8 at a spatial resolution of 30 meters squared on July 4, 2021, a cloud-free day. The weighted average NDVI of each block group excludes bodies of water.
```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
pal_terrain = terrain.colors(100) %>% rev()#reverse the order of the palette
mv_den_co_bg_ndvi  = den_co_bg_pop_per_ndvi %>% 
  dplyr::select(bg_fips, ndvi_mean_wt) %>% 
  mapview(
    layer.name = "NDVI, block group",
    zcol = "ndvi_mean_wt",
    col.regions = pal_terrain, 
    at = seq(-0.1, 1, 0.1)
  )
mv_den_co_bg_ndvi@map %>% 
  addFullscreenControl()
```

# Measures considering both population density and NDVI
Consider two options characterizing block groups:

1. Population density per NDVI (population density per square mile / NDVI)
2. Block-group rank of the above.

The first is somewhat difficult to visualize on a map because the distribution has a right skew with some very high values and most much lower.
```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
summary(den_co_bg_pop_per_ndvi$pop_dens_per_ndvi)
den_co_bg_pop_per_ndvi %>% 
  ggplot(aes(pop_dens_per_ndvi))+
  geom_histogram()
```

The second is easier to visualize because the distribution is uniform by definition (a simple rank).
```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
summary(den_co_bg_pop_per_ndvi$pop_dens_per_ndvi_rank)
den_co_bg_pop_per_ndvi %>% 
  ggplot(aes(pop_dens_per_ndvi_rank))+
  geom_histogram()
```

Map them both.
```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
library(viridis)
library(scales)
mv_pop_dens_per_ndvi=den_co_bg_pop_per_ndvi %>% 
  mapview(
    col.regions = viridis_pal(option = "C"),
    layer.name = "Population density per NDVI",
    zcol = "pop_dens_per_ndvi")

mv_rank=den_co_bg_pop_per_ndvi %>% 
  mapview(
    col.regions = viridis_pal(option = "C"),
    layer.name = "Population density per NDVI, rank",
    zcol = "pop_dens_per_ndvi_rank")

mv_both = mv_pop_dens_per_ndvi +
  mv_rank

mv_both@map %>% 
  leaflet.extras::addFullscreenControl()
```
