---
title: "Visualize health-impact assessment scenarios"
author: "Michael D Garber"
date: "Revised April 8 2022"
output: 
  html_document:
    toc: true  
    toc_float: true
bibliography: references.bib
---

```{r loadpackages, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
library(here)
library(tidyverse)
library(sf)
library(terra)
library(raster) 
library(mapview)
library(knitr) #to make sure kable works
library(viridis)
library(scales)
library(lubridate) #for ggplot
library(leaflet)
library(leaflet.extras)
```

# Introduction

This document visualizes proposed policy scenarios for adding more green space to the City of Denver. These scenarios were informed by local stakeholders and will be considered in a health-impact assessment.

1.  Add native plants to all census block groups such that

    -   30% of the block group's area is as green as native plants
    -   20% of the block group's area is as green as native plants

2.  Create native buffers around riparian areas (rivers, streams, lakes, and ponds) of the following sizes:

    -   200 feet (ideal for ecosystem health but possibly not realistic)
    -   100 feet (compromise)
    -   50 feet (most realistic; less good for ecosystem health)

3.  Initiatives related to green infrastructure and stormwater management. (Please refer to corresponding section for details.)

4.  Replace a portion of parking-lot surface with native plants:

    -   100% of the existing parking area
    -   50% of the existing parking area
    -   20% of the existing parking area

For all scenarios, we measured green-space exposure by the normalized difference vegetation index (NDVI) measured by the Landsat-8 satellite at a spatial resolution of 30 meters squared. To determine the target (alternative) NDVI value, we measured the NDVI of a 100% native zone in the Denver Botanic Gardens on several cloud-free spring and summer days. The NDVI value was about 0.5 in this area, so, preliminary, we consider 0.5 as the NDVI corresponding to native plants (subject to change; please see corresponding document).

# Scenario 1: add native plants to all census block groups

Under the first scenario, which we view as the most ambitious, we consider the expected impact on mortality by applying a green-space intervention to all census block groups, without specifying where. This scenario was informed by conversations with colleagues who stated that

We first measured the mean NDVI of each census block group on July 4, 2021. The weighted block-group-level mean is presented here, weighted by the proportion each 30 square-meter pixel covers by the census block group. For example, if half of a pixel overlaps the block group, it receives a weight of 0.5 in the weighted average. We also removed bodies of water before measuring NDVI.

```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
setwd(here("data-processed"))
load("den_co_bg_ndvi.RData")
load("mv_ndvi_pixel_bg.RData")
load("mv_ndvi_den_co_20210704.RData")
load("mv_den_co_bg_ndvi.RData")
#mv_den_co_bg_ndvi
pal_terrain = terrain.colors(100) %>% rev()#reverse the order of the palette
mv_den_co_bg_ndvi  = den_co_bg_ndvi %>% 
  dplyr::select(bg_fips, ndvi_mean_wt) %>% 
  mapview(
    layer.name = "NDVI, block group",
    zcol = "ndvi_mean_wt",
    col.regions = pal_terrain, 
    at = seq(-0.1, 1, 0.1)
  )
mv_den_co_bg_ndvi@map %>% 
  leaflet.extras::addFullscreenControl()
```

We excluded census block whose baseline NDVI was above the native-plant threshold:

```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
library(RColorBrewer)
setwd(here("data-processed"))
ndvi_below_thresh_pal = RColorBrewer::brewer.pal(3, "RdYlGn")[c(1,3)]  %>% rev()
mv_bg_below_native_threshold =den_co_bg_ndvi %>% 
  mutate(
  ndvi_below_native_threshold_char = case_when(
    ndvi_below_native_threshold == 1 ~ "Yes",
    ndvi_below_native_threshold == 0 ~ "No"
  )) %>% 
  dplyr::select(bg_fips, ndvi_below_native_threshold_char) %>% 
  mapview(
    layer.name = "NDVI below native threhsold",
    zcol = "ndvi_below_native_threshold_char",
    col.regions = ndvi_below_thresh_pal
  )

mv_bg_below_native_threshold@map %>% 
  addFullscreenControl()
```

# Scenario 2: add native-plants buffers to riparian areas

We measured NDVI in a 200-foot buffer, a 100-foot buffer, and a 50-foot buffer around all bodies of water in Denver. We downloaded bodies of water from OpenStreetMap (code [here](https://github.com/michaeldgarber/green-space-denver/blob/main/scripts/0_load_denver_osm_parks_water.R)). We defined residential exposure to these riparian areas as those individuals living within a 500-meter buffer, following research on green-space and health that have defined green-space exposure based on residential proximity. [@rojas-rueda2019] We estimated the number of people in this buffer by multiplying the population density of the census block group by the intersecting area.

The below map depicts mean NDVI in the portions of census block groups that intersect a 200-foot buffer as well as those pieces that intersect the part of the 500 m buffer that would not be intervened upon, i.e., the part between the 200-foot buffer and the edge of the 500 m buffer.

```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
library(here)
setwd(here("data-processed"))
load("den_bg_int_wtr_500m_200ft_comp_ndvi.RData")
load("den_bg_int_wtr_200ft_ndvi.RData")
load("den_co_osm_wtr.RData")
load("study_area_2876.RData")
pal_terrain_col = rev(terrain.colors(100)) 
mv_den_bg_int_wtr_500m_200ft_comp_ndvi= den_bg_int_wtr_500m_200ft_comp_ndvi %>% 
  mapview(
    col.regions = pal_terrain_col,
    at = seq(-.1, 1, 0.1), #0 to 1 by .1; define the breaks so consistent between layers
    layer.name = "NDVI, 200 ft - 500 m",
    zcol = "ndvi_mean_wt_500m_200ft_comp")

mv_den_bg_int_wtr_200ft_ndvi= den_bg_int_wtr_200ft_ndvi %>% 
  mapview(
    col.regions = pal_terrain_col,
    at = seq(-.1, 1, 0.1), #0 to 1 by .1; define the breaks so consistent between layers
    layer.name = "NDVI, 200 ft",
    zcol = "ndvi_mean_wt_200ft")

mv_den_co_osm_wtr = den_co_osm_wtr %>% 
  st_intersection(study_area_2876) %>% 
  mapview(
    layer.name = "Water type",
    col.regions = rainbow(n_distinct(den_co_osm_wtr$water_type)),
    zcol = "water_type")

#### Visualize all at once--------
mv_rip_all3 = mv_den_bg_int_wtr_200ft_ndvi+ mv_den_bg_int_wtr_500m_200ft_comp_ndvi +mv_den_co_osm_wtr
mv_rip_all3@map %>% 
  addFullscreenControl()
```

# Scenario 3: green infrastructure

We spoke with representatives at the local Office of Green Infrastructure, and they described three categories of initiatives--some planned, some aspirational--that could include native or adapted plants.

-   Large stormwater retention projects:
    -   Large ponds or basin located on public property that treat collect and treat stormwater after it has been collected in a storm pipe. They are usually vegetated, often with native or adapted plants.
    -   Expect about 75% of the facility's footprint to have native or adapted plants.
-   Green streets
    -   Historically, about 2.7 miles of green streets each year, and each mile equates to about 0.15 acres of native or vegetated landscape.
    -   Short term goal: increase output to 5.0 miles of green streets; same amount of vegetation per green mile
    -   Aspirational goal: output to 5.0 miles; increase vegetated area to 0.75 acres per green mile
-   Site new or re-development stormmwater controls
    -   As properties develop or redevelop, they may be required to include stormwater runoff control measures to offset negative impacts to flooding and water quality downstream of the site associated with the impervious surfaces added during the development. These stormwater control measures are often green-on-the-ground practices vegetated with native or adapted plants.
    -   The requirements may differ by parcel size. A rough guess that projects that may require stormwater control by parcel size:
        -   greater than 1 acre: about 100 sites per year
        -   0.5-1.0 acre: about 25 sites per year
        -   less than 0.5 acre: 400 sites per year

## 3.1. Large stormwater retention ponds

We were provided a list of planned projects throughout Denver. Based on our conversations, we assume that about 75% of the project's footprint would consist of native or vegetation, so our intervention is defined as changing the NDVI values of these polygons from their baseline value (on July 4 2021) to the native-plant value of 0.5 As we did for the riparian areas, we defined exposure to the projects as those individuals living within a 500 m buffer of the projects. A map of baseline NDVI of the projects themselves and of a 500 m buffer around the projects is below.

```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
library(here)
setwd(here("data-processed"))
load("den_bg_int_ogi_proj_500m_comp_ndvi.RData")
load("den_bg_int_ogi_proj_only_ndvi.RData")
load("den_co_osm_wtr.RData")
load("study_area_2876.RData")
pal_terrain_col = rev(terrain.colors(100)) 

#### 500 mBuffer excluding the project---------
mv_den_bg_int_ogi_proj_500m_comp_ndvi= den_bg_int_ogi_proj_500m_comp_ndvi %>% 
  mapview(
    col.regions = pal_terrain_col,
    at = seq(-.1, 1, 0.1), #0 to 1 by .1; define the breaks so consistent between layers
    layer.name = "NDVI, 500m buffer, projects",
    zcol = "ndvi_mean_wt_500m_ogi_proj_comp")

#### The project only----------
mv_den_bg_int_ogi_proj_only_ndvi= den_bg_int_ogi_proj_only_ndvi %>% 
  mapview(
    col.regions = pal_terrain_col,
    at = seq(-.1, 1, 0.1), #0 to 1 by .1; define the breaks so consistent between layers
    layer.name = "NDVI, projects only",
    zcol = "ndvi_mean_wt_ogi_proj_only")

#### Bodies of water--------
load("den_co_osm_water_union.RData")
load("den_co_osm_water.RData")
mv_den_co_osm_water = den_co_osm_water %>% 
  st_intersection(study_area_2876) %>% 
  mapview(
    layer.name = "Water type",
    col.regions = rainbow(n_distinct(den_co_osm_water$water_type)),
    zcol = "water_type")

#### Visualize all at once--------------
mv_ogi_proj_all3 = mv_den_bg_int_ogi_proj_500m_comp_ndvi+ 
  mv_den_bg_int_ogi_proj_only_ndvi +mv_den_co_osm_wtr
mv_ogi_proj_all3@map %>% 
  addFullscreenControl()
```

## 3.2. Green streets

to-do

## 3.3. Site new or re-development storwmater controls

The approach for estimating the health impact of the redevelopment controls is different from scenarios 2 and 3.a. because we do not know where the re-developments will occur. We thus simulated possible scenarios. As stated above, we anticipate the following number of parcels will be subject to these rules per year:

-   greater than 1 acre: about 100 sites per year
-   0.5-1.0 acre: about 25 sites per year
-   less than 0.5 acre: 400 sites per year

We gathered data on parcels from Denver's Open Data Portal ([Existing Landuse 2018](https://www.denvergov.org/opendata/dataset/city-and-county-of-denver-existing-landuse-2018)) and measured their area. A subset of these parcels near Union Station is mapped below.

```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
library(here)
setwd(here("data-processed"))
load("den_landuse_union_sta.RData")

mv_landuse_union_sta = den_landuse_union_sta %>% 
  dplyr::select(-starts_with("address")) %>% 
  mapview(
    zcol = "CPD_LANDUS",
    layer.name = "Land-use type",
    col.regions = rainbow(n=n_distinct(den_landuse_union_sta$CPD_LANDUS)))
mv_landuse_union_sta@map %>% 
  addFullscreenControl()
```

Then, from all parcels, we sampled 100 sites of size greater than 1 acre, 25 sites of size 0.5-1 acre, and 400 sites less than 0.5 acres. One such sample appears below.

```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
library(here)
setwd(here("data-processed"))
load("den_landuse_sample.RData")
mv_den_landuse_sample = den_landuse_sample %>% 
  mapview(
    layer.name = "Parcel size category",
    zcol = "parcel_size_cat")
mv_den_landuse_sample@map %>% 
  addFullscreenControl()
```

From this point, we followed the same framework as we've done for other projects. We estimated that about 50% of this redevelopment would be native (subject to change), and we considered those exposed to these re-developments as anyone living within 500 m of them. The baseline NDVI of the sampled parcels and that of their corresponding 500m buffers is visualized below.

```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
setwd(here("data-processed"))
load("den_bg_int_parcel_500m_comp_ndvi.RData")
load("den_bg_int_parcel_only_ndvi.RData")
load("study_area_2876.RData")
load("union_station_1_mi_4326.RData") # we will limit to a 1-mi radius around union station
pal_terrain_col = rev(terrain.colors(100)) 
library(leaflet.extras)
library(mapview)
#### Buffer excluding the parking---------
sf::sf_use_s2(FALSE) #have to use this as I was getting an error that loop not valid
mv_union_sta_den_bg_int_parcel_500m_comp_ndvi= den_bg_int_parcel_500m_comp_ndvi %>% 
  mapview(
    col.regions = pal_terrain_col,
    layer.name = "NDVI, 500 m buffer, parcel",
    zcol = "ndvi_mean_wt_500m_parcel_comp")

#### The parking only----------
mv_union_sta_den_bg_int_parcel_only_ndvi= den_bg_int_parcel_only_ndvi %>% 
  mapview(
    col.regions = pal_terrain_col,
    layer.name = "NDVI, parcel only",
    zcol = "ndvi_mean_wt_parcel_only")

#### Visualize all at once--------------
mv_parcel_both = mv_union_sta_den_bg_int_parcel_500m_comp_ndvi+ 
  mv_union_sta_den_bg_int_parcel_only_ndvi

mv_parcel_both@map %>% 
  addFullscreenControl()
```

# Scenario 4: add native plants to parking lots

We obtained spatial data on [parking lots](https://www.denvergov.org/opendata/dataset/parking-lots-2016) from the City of Denver Open Data Catalog. About 9% of Denver's area is a parking lot:

```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
setwd(here("data-processed"))
load("den_prkng_marg.RData")
den_prkng_marg %>% 
  st_set_geometry(NULL) %>% 
  mutate(
    den_area_mi2_total = 155,
    prop_den_parking = area_mi2_prkng/den_area_mi2_total
         ) %>% 
  dplyr::select(-starts_with("area_ft2")) %>% 
  knitr::kable(digits = 2)
```

We similarly measured the NDVI on the parking lots as well as the NDVI in the census block groups that are within a 500-m buffer radius of any parking lots (which is most).

We present a small subset near Union Station, as the file size visualizing the NDVI measurements for the full city exceeds GitHub's file-upload limits:

```{r,  eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
setwd(here("data-processed"))
load("den_bg_int_prkng_500m_comp_ndvi.RData")
load("den_bg_int_prkng_only_ndvi.RData")
load("study_area_2876.RData")
load("union_station_1_mi_4326.RData") # we will limit to a 1-mi radius around union station
pal_terrain_col = rev(terrain.colors(100)) 
library(leaflet.extras)
library(mapview)
#### Buffer excluding the parking---------
sf::sf_use_s2(FALSE) #have to use this as I was getting an error that loop not valid
mv_union_sta_den_bg_int_prkng_500m_comp_ndvi= den_bg_int_prkng_500m_comp_ndvi %>% 
  st_intersection(union_station_1_mi_4326) %>% 
  st_make_valid() %>% 
  st_buffer(0) %>% 
  mapview(
    col.regions = pal_terrain_col,
    layer.name = "NDVI, 500 m buffer, parking",
    zcol = "ndvi_mean_wt_500m_prkng_comp")

#### The parking only----------
mv_union_sta_den_bg_int_prkng_only_ndvi= den_bg_int_prkng_only_ndvi %>% 
  st_intersection(union_station_1_mi_4326) %>% 
  st_make_valid() %>% 
  st_buffer(0) %>% 
  mapview(
    col.regions = pal_terrain_col,
    layer.name = "NDVI, parking only",
    zcol = "ndvi_mean_wt_prkng_only")

#### Visualize all at once--------------
mv_prkng_both = mv_union_sta_den_bg_int_prkng_500m_comp_ndvi+ 
  mv_union_sta_den_bg_int_prkng_only_ndvi

mv_prkng_both@map %>% 
  addFullscreenControl()
```

# References
